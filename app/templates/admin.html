{% extends "layout.html" %}
{% block content %}
<div class="space-y-8">
    <!-- Invite New User Section -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Invite New User</h3>
        <form method="POST" action="">
            {{ invite_form.hidden_tag() }}
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        {{ invite_form.name.label(class="block text-sm font-medium text-gray-700") }}
                        {{ invite_form.name(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm") }}
                        {% if invite_form.name.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in invite_form.name.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        {{ invite_form.email.label(class="block text-sm font-medium text-gray-700") }}
                        {{ invite_form.email(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm") }}
                        {% if invite_form.email.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in invite_form.email.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        {{ invite_form.role.label(class="block text-sm font-medium text-gray-700") }}
                        {{ invite_form.role(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm") }}
                         {% if invite_form.role.errors %}
                            <div class="text-red-500 text-xs mt-1">
                                {% for error in invite_form.role.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <button type="submit" name="invite_user" class="px-4 py-2 border rounded-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        Send Invitation
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Manage Properties Section -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Manage Properties</h3>
        
        <!-- Add New Property Form -->
        <div class="mb-8 border-b pb-6">
            <h4 class="text-md font-medium text-gray-600 mb-2">Add New Property</h4>
            <form method="POST" action="{{ url_for('main.add_property') }}">
                {{ property_form.hidden_tag() }}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        {{ property_form.name.label(class="block text-sm font-medium text-gray-700") }}
                        {{ property_form.name(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
                    </div>
                    <div>
                        {{ property_form.address.label(class="block text-sm font-medium text-gray-700") }}
                        {{ property_form.address(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
                    </div>
                    <div>
                        {{ property_form.property_manager.label(class="block text-sm font-medium text-gray-700") }}
                        {{ property_form.property_manager(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
                    </div>
                </div>
                <div class="mt-4">
                    {{ property_form.submit(class="px-4 py-2 border rounded-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700") }}
                </div>
            </form>
        </div>

        <!-- Existing Properties Table -->
        <h4 class="text-md font-medium text-gray-600 mb-2">Existing Properties</h4>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">Property Name</th>
                        <th scope="col" class="px-6 py-3">Address</th>
                        <th scope="col" class="px-6 py-3">Property Manager</th>
                        <th scope="col" class="px-6 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prop in properties %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">{{ prop.name }}</td>
                        <td class="px-6 py-4">{{ prop.address }}</td>
                        <td class="px-6 py-4">{{ prop.property_manager or 'N/A' }}</td>
                        <td class="px-6 py-4 flex items-center space-x-4">
                            <a href="{{ url_for('main.edit_property', property_id=prop.id) }}" class="font-medium text-indigo-600 hover:text-indigo-900">Edit</a>
                            {% if current_user.role == 'Super User' %}
                            <form action="{{ url_for('main.delete_property', property_id=prop.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this property? This action cannot be undone.');">
                                <button type="submit" class="font-medium text-red-600 hover:text-red-900">Delete</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Manage Users Table -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Manage Users</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">ID</th>
                        <th scope="col" class="px-6 py-3">Name</th>
                        <th scope="col" class="px-6 py-3">Email</th>
                        <th scope="col" class="px-6 py-3">Role</th>
                        <th scope="col" class="px-6 py-3">Status</th>
                        <th scope="col" class="px-6 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4">{{ user.id }}</td>
                        <td class="px-6 py-4">{{ user.name }}</td>
                        <td class="px-6 py-4">{{ user.email }}</td>
                        <td class="px-6 py-4">{{ user.role }}</td>
                        <td class="px-6 py-4">
                            {% if user.is_active %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                            {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Invited</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 flex items-center space-x-4">
                            {% if current_user.role == 'Super User' or (current_user.role == 'Admin' and user.role not in ['Admin', 'Super User']) %}
                                <a href="{{ url_for('main.edit_user', user_id=user.id) }}" class="font-medium text-indigo-600 hover:text-indigo-900">Edit</a>
                            {% endif %}
                            {% if current_user.role == 'Super User' and user != current_user %}
                                <form action="{{ url_for('main.delete_user', user_id=user.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to permanently delete this user? This cannot be undone.');">
                                    <button type="submit" class="font-medium text-red-600 hover:text-red-900">Delete</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if current_user.role == 'Super User' %}
    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-red-500">
        <h3 class="text-lg font-semibold text-gray-700 mb-1">Add User Directly (Super User Only)</h3>
        <p class="text-sm text-gray-600 mb-4">
            This form creates an active user immediately with the specified password. Use for testing or internal setup.
        </p>
        <form method="POST" action="">
            {{ add_user_form.hidden_tag() }}
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        {{ add_user_form.name.label(class="block text-sm font-medium text-gray-700") }}
                        {{ add_user_form.name(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
                        {% for error in add_user_form.name.errors %}<span class="text-red-500 text-xs">{{ error }}</span>{% endfor %}
                    </div>
                    <div>
                        {{ add_user_form.email.label(class="block text-sm font-medium text-gray-700") }}
                        {{ add_user_form.email(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
                        {% for error in add_user_form.email.errors %}<span class="text-red-500 text-xs">{{ error }}</span>{% endfor %}
                    </div>
                    <div>
                        {{ add_user_form.password.label(class="block text-sm font-medium text-gray-700") }}
                        {{ add_user_form.password(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
                        {% for error in add_user_form.password.errors %}<span class="text-red-500 text-xs">{{ error }}</span>{% endfor %}
                    </div>
                    <div>
                        {{ add_user_form.role.label(class="block text-sm font-medium text-gray-700") }}
                        {{ add_user_form.role(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
                        {% for error in add_user_form.role.errors %}<span class="text-red-500 text-xs">{{ error }}</span>{% endfor %}
                    </div>
                </div>
                <div>
                    <button type="submit" name="add_user" class="px-4 py-2 border rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">
                        Add User
                    </button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}
</div>
{% endblock content %}
