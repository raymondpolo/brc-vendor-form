{% extends "layout.html" %}
{% block content %}
<div class="bg-white p-2 md:p-6 rounded-lg shadow-md">
    <div id="calendar"></div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<style>
    /* Custom FullCalendar Theme */
    :root {
        --fc-border-color: #e5e7eb;
        --fc-today-bg-color: rgba(79, 70, 229, 0.1);
    }

    /* Toolbar buttons */
    .fc .fc-button-primary {
        background-color: #4f46e5;
        border-color: #4f46e5;
    }
    .fc .fc-button-primary:hover,
    .fc .fc-button-primary:focus {
        background-color: #4338ca;
        border-color: #4338ca;
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active {
        background-color: #3730a3;
        border-color: #3730a3;
    }

    /* Event styles */
    .fc-event {
        cursor: pointer;
    }
    .fc-daygrid-event, .fc-list-event-title {
        font-size: 0.8rem;
    }
    
    /* Popover for "+more" link */
    .fc-popover {
        z-index: 20;
    }

    /* Style for non-clickable day numbers */
    .fc-daygrid-day.fc-day-has-no-events .fc-daygrid-day-number {
        pointer-events: none;
        color: #9ca3af; /* Lighter color for disabled days */
    }

    /* --- Responsive Adjustments --- */
    @media (max-width: 576px) {
        /* Stack the toolbar on mobile */
        .fc .fc-header-toolbar {
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        .fc .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }
        .fc .fc-toolbar-title {
            font-size: 1.25rem;
        }
        .fc .fc-button {
            padding: 0.4em 0.65em;
            font-size: 0.85rem;
        }
        
        /* Reduce font size of day numbers to prevent wrapping and scrolling */
        .fc .fc-daygrid-day-number {
            font-size: 0.75em;
            padding: 2px;
        }
        .fc .fc-daygrid-day-top {
            justify-content: center; /* Center the day number */
        }

        /* Make day headers smaller */
        .fc-col-header-cell-cushion {
            font-size: 0.75em;
            padding: 2px 4px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar;

        function renderCalendar() {
            var isMobile = window.innerWidth < 768;

            if (calendar) {
                calendar.destroy();
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                // --- NEW: Toolbar layout updated ---
                headerToolbar: {
                    left: '',
                    center: 'prev,title,next',
                    right: 'today dayGridMonth,listWeek'
                },
                events: '/api/events',
                navLinks: true,
                editable: false,
                
                // --- CORE FIXES FOR MOBILE ---
                showNonCurrentDates: true, 
                fixedWeekCount: false,
                height: 'auto',
                dayHeaderFormat: isMobile ? { weekday: 'narrow' } : { weekday: 'short' },
                dayMaxEvents: isMobile ? 0 : 3,
                
                dayCellDidMount: function(arg) {
                    var dateStr = arg.date.toISOString().slice(0, 10);
                    var eventsOnDay = calendar.getEvents().filter(function(event) {
                        return event.start && event.start.toISOString().slice(0, 10) === dateStr;
                    });
                    if (eventsOnDay.length === 0) {
                        arg.el.classList.add('fc-day-has-no-events');
                    }
                },
                
                navLinkDayClick: function(date, jsEvent) {
                    var dateStr = date.toISOString().slice(0, 10);
                    var eventsOnDay = calendar.getEvents().filter(function(event) {
                        return event.start && event.start.toISOString().slice(0, 10) === dateStr;
                    });

                    if (eventsOnDay.length === 0) {
                        jsEvent.preventDefault();
                    }
                },

                eventDidMount: function(info) {
                    if (!isMobile) {
                        var props = info.event.extendedProps;
                        info.el.setAttribute('title',
                            `Type: ${props.type}\n` +
                            `Status: ${props.status}\n` +
                            `Requester: ${props.requester}`
                        );
                    }
                },
                
                eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    if (info.event.url) {
                        window.open(info.event.url, "_self");
                    }
                }
            });

            calendar.render();
        }

        // Initial render
        renderCalendar();

        // Re-render on window resize to apply responsive options
        var resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(renderCalendar, 250);
        });
    });
</script>
{% endblock content %}