{% extends "layout.html" %}
{% block content %}
<div class="bg-white p-2 md:p-6 rounded-lg shadow-md">

    <div class="custom-calendar-toolbar">
        <div class="toolbar-nav">
            <button type="button" data-command="prev" class="fc-button fc-button-primary">&lsaquo;</button>
            <h2 id="calendar-title" class="calendar-title">Loading...</h2>
            <button type="button" data-command="next" class="fc-button fc-button-primary">&rsaquo;</button>
        </div>
        <div class="toolbar-views">
            <button type="button" data-command="today" class="fc-button fc-today-button">today</button>
            <div class="fc-button-group">
                <button type="button" data-command="month" class="fc-button fc-button-primary fc-button-active">month</button>
                <button type="button" data-command="list" class="fc-button fc-button-primary">list</button>
            </div>
        </div>
    </div>

    <div id="calendar"></div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<style>
    :root {
        --fc-border-color: #e5e7eb;
        --fc-today-bg-color: rgba(79, 70, 229, 0.1);
    }

    .fc .fc-button-primary {
        background-color: #4f46e5;
        border-color: #4f46e5;
        color: #fff;
    }
    .fc .fc-button-primary:hover, .fc .fc-button-primary:focus {
        background-color: #4338ca;
        border-color: #4338ca;
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active {
        background-color: #3730a3;
        border-color: #3730a3;
    }

    .fc .fc-today-button {
        background-color: #6b7280;
        border-color: #6b7280;
        color: #fff;
    }
    .fc .fc-today-button:hover, .fc .fc-today-button:focus {
        background-color: #4b5563;
        border-color: #4b5563;
    }
    
    /* Ensure custom buttons inherit FullCalendar's base styles */
    .fc-button {
        display: inline-block;
        font-weight: 500;
        padding: 0.5em 1em;
        font-size: 0.9rem;
        border-radius: 0.375rem;
        border: 1px solid transparent;
        transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
    }
    
    .fc-button-group > .fc-button:not(:first-child) {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        margin-left: -1px;
    }
    .fc-button-group > .fc-button:not(:last-child) {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }


    .fc-event { cursor: pointer; }
    .fc-daygrid-event, .fc-list-event-title { font-size: 0.8rem; }
    .fc-popover { z-index: 20; }
    .fc-daygrid-day.fc-day-has-no-events .fc-daygrid-day-number {
        pointer-events: none;
        color: #9ca3af;
    }

    @media (max-width: 576px) {
        .fc .fc-button {
            padding: 0.4em 0.65em;
            font-size: 0.85rem;
        }
        .fc .fc-daygrid-day-number {
            font-size: 0.75em;
            padding: 2px;
        }
        .fc .fc-daygrid-day-top {
            justify-content: center;
        }
        .fc-col-header-cell-cushion {
            font-size: 0.75em;
            padding: 2px 4px;
        }
    }

    /* âœ… Custom Toolbar Layout */
    .custom-calendar-toolbar {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 1.5rem;
        gap: 0.75rem;
    }
    .toolbar-nav {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .toolbar-views {
        display: flex;
        align-items: center;
        gap: 0.5rem; /* Space between 'today' and the 'month/list' group */
    }
    .calendar-title {
        font-size: 1.5rem;
        font-weight: 500;
        text-align: center;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        let calendar;

        function renderCalendar() {
            const isMobile = window.innerWidth < 768;

            if (calendar) calendar.destroy();

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: false, // Use custom toolbar
                events: '/api/events',
                navLinks: true,
                editable: false,
                showNonCurrentDates: true,
                fixedWeekCount: false,
                height: 'auto',
                dayHeaderFormat: isMobile ? { weekday: 'narrow' } : { weekday: 'short' },
                dayMaxEvents: isMobile ? 0 : 3,

                dayCellDidMount: function (arg) {
                    const dateStr = arg.date.toISOString().slice(0, 10);
                    const eventsOnDay = calendar.getEvents().filter(event =>
                        event.start && event.start.toISOString().slice(0, 10) === dateStr
                    );
                    if (eventsOnDay.length === 0) {
                        arg.el.classList.add('fc-day-has-no-events');
                    }
                },

                navLinkDayClick: function (date, jsEvent) {
                    const dateStr = date.toISOString().slice(0, 10);
                    const eventsOnDay = calendar.getEvents().filter(event =>
                        event.start && event.start.toISOString().slice(0, 10) === dateStr
                    );
                    if (eventsOnDay.length === 0) {
                        jsEvent.preventDefault();
                    }
                },

                eventDidMount: function (info) {
                    if (!isMobile) {
                        const props = info.event.extendedProps;
                        info.el.setAttribute('title',
                            `Type: ${props.type}\n` +
                            `Status: ${props.status}\n` +
                            `Requester: ${props.requester}`
                        );
                    }
                },

                eventClick: function (info) {
                    info.jsEvent.preventDefault();
                    if (info.event.url) {
                        window.open(info.event.url, "_self");
                    }
                }
            });

            calendar.render();

            const titleEl = document.getElementById('calendar-title');
            titleEl.textContent = calendar.view.title;
            calendar.on('datesSet', function (info) {
                titleEl.textContent = info.view.title;
            });

            document.querySelectorAll('.custom-calendar-toolbar [data-command]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const cmd = btn.getAttribute('data-command');
                    if (cmd === 'prev') calendar.prev();
                    else if (cmd === 'next') calendar.next();
                    else if (cmd === 'today') calendar.today();
                    else if (cmd === 'month') calendar.changeView('dayGridMonth');
                    else if (cmd === 'list') calendar.changeView('listWeek');
                });
            });
        }

        renderCalendar();

        let resizeTimer;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(renderCalendar, 250);
        });
    });
</script>
{% endblock content %}