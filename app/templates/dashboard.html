{% extends "layout.html" %}
{% block content %}
    <div class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-5 mb-6">
        <a href="{{ url_for('main.all_requests') }}" class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-500 hover:bg-gray-50">
            <h3 class="text-xs font-medium text-gray-500 uppercase whitespace-nowrap">Total</h3>
            <p class="mt-1 text-2xl font-bold text-gray-800">{{ stats.get('totalRequests', 0) }}</p>
        </a>
        {% for status in all_statuses %}
        <a href="{{ url_for('main.requests_by_status', status=status) }}" class="bg-white p-4 rounded-lg shadow-md border-l-4 {{ status_colors.get(status, {}).get('border', 'border-gray-500') }} hover:bg-gray-50">
            <h3 class="text-xs font-medium text-gray-500 uppercase whitespace-nowrap">{{ status }}</h3>
            <p class="mt-1 text-2xl font-bold text-gray-800">{{ stats.get(status, 0) }}</p>
        </a>
        {% endfor %}
    </div>

    <div class="mb-6 border-t pt-4">
        <h3 class="text-sm font-semibold text-gray-600 mb-2">Tags Overview</h3>
        <div class="flex flex-wrap gap-4">
            <a href="{{ url_for('main.requests_by_tag', tag_name='Approved') }}" class="bg-white p-3 rounded-lg shadow-sm flex items-center space-x-3 border-l-4 {{ tag_colors.get('Approved', {}).get('border', 'border-gray-500') }} hover:bg-gray-50">
                <span class="text-xs font-semibold text-gray-700">Approved:</span>
                <span class="text-lg font-bold text-gray-800">{{ tag_stats.approved }}</span>
            </a>
            <a href="{{ url_for('main.requests_by_tag', tag_name='Declined') }}" class="bg-white p-3 rounded-lg shadow-sm flex items-center space-x-3 border-l-4 {{ tag_colors.get('Declined', {}).get('border', 'border-gray-500') }} hover:bg-gray-50">
                <span class="text-xs font-semibold text-gray-700">Declined:</span>
                <span class="text-lg font-bold text-gray-800">{{ tag_stats.declined }}</span>
            </a>
            <a href="{{ url_for('main.requests_by_tag', tag_name='Follow-up needed') }}" class="bg-white p-3 rounded-lg shadow-sm flex items-center space-x-3 border-l-4 {{ tag_colors.get('Follow-up needed', {}).get('border', 'border-gray-500') }} hover:bg-gray-50">
                <span class="text-xs font-semibold text-gray-700">Follow-up Needed:</span>
                <span class="text-lg font-bold text-gray-800">{{ tag_stats.follow_up }}</span>
            </a>
             <a href="{{ url_for('main.requests_by_tag', tag_name='Go-back') }}" class="bg-white p-3 rounded-lg shadow-sm flex items-center space-x-3 border-l-4 {{ tag_colors.get('Go-back', {}).get('border', 'border-gray-500') }} hover:bg-gray-50">
                <span class="text-xs font-semibold text-gray-700">Go-back:</span>
                <span class="text-lg font-bold text-gray-800">{{ tag_stats.go_back }}</span>
            </a>
        </div>
    </div>

    <div class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-700 mb-4">Requests by Status</h3><div class="h-64"><canvas id="statusChart"></canvas></div></div>
            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-700 mb-4">Requests by Type</h3><div class="h-64"><canvas id="typeChart"></canvas></div></div>
            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-700 mb-4">Requests by Vendor</h3><div class="h-64"><canvas id="vendorChart"></canvas></div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-700 mb-4">Approvals by PM</h3><div class="h-64"><canvas id="approvedByPmChart"></canvas></div></div>
            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-700 mb-4">Declines by PM</h3><div class="h-64"><canvas id="declinedByPmChart"></canvas></div></div>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-700 mb-4">Requests by Property</h3><div class="h-64"><canvas id="propertyChart"></canvas></div></div>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-700 mb-4">Go-backs by Vendor</h3><div class="h-64"><canvas id="gobackByVendorChart"></canvas></div></div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chartData = {{ chart_data|tojson }};
        const pieChartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } };
        const barChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        };

        // Options for the horizontal property chart
        const horizontalBarChartOptions = {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        };

        const createChart = (ctx, type, data, options, customColors = null) => {
            if (ctx && data && data.labels && data.labels.length > 0) {
                const chartConfig = {
                    type: type,
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.data,
                            backgroundColor: data.colors || customColors || [
                                'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 99, 132, 0.8)', 'rgba(255, 159, 64, 0.8)',
                                'rgba(128, 128, 128, 0.8)'
                            ],
                            borderColor: '#fff',
                            borderWidth: 1
                        }]
                    },
                    options: options
                };
                if (type === 'bar') {
                    chartConfig.data.datasets[0].label = 'Count';
                }
                new Chart(ctx, chartConfig);
            } else if (ctx) {
                ctx.canvas.parentNode.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No data to display.</div>';
            }
        };

        // Row 1
        createChart(document.getElementById('statusChart').getContext('2d'), 'doughnut', chartData.status, pieChartOptions);
        createChart(document.getElementById('typeChart').getContext('2d'), 'bar', chartData.type, barChartOptions);
        createChart(document.getElementById('vendorChart').getContext('2d'), 'pie', chartData.vendor, pieChartOptions);
        
        // Row 2
        createChart(document.getElementById('approvedByPmChart').getContext('2d'), 'bar', chartData.approved_by_pm, barChartOptions);
        createChart(document.getElementById('declinedByPmChart').getContext('2d'), 'bar', chartData.declined_by_pm, barChartOptions);

        // Row 3 (Requests by Property - Now Horizontal)
        createChart(document.getElementById('propertyChart').getContext('2d'), 'bar', chartData.property, horizontalBarChartOptions);

        // Row 4
        createChart(document.getElementById('gobackByVendorChart').getContext('2d'), 'bar', chartData.goback_by_vendor, barChartOptions);
    });
</script>
{% endblock content %}